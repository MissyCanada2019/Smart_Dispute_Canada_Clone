{% extends "base.html" %}
{% block title %}Review Case{% endblock %}

{% block content %}
<div class="container mt-5">
  <h3 class="text-danger">Case Review</h3>

  <p><strong>Suggested Form:</strong> {{ form_info.form_name }}</p>
  <p><strong>Court:</strong> {{ form_info.court }}</p>
  <p><strong>Merit Score:</strong> {{ merit_score }}%</p>
  <p>{{ explanation }}</p>

  {% if not case.is_paid and current_user.subscription_type not in ["monthly", "yearly"] %}
    <div class="alert alert-info mt-4">
      <strong>Preview:</strong> Below is a locked preview of your legal form.
      Subscribe or pay to unlock full access.
    </div>

    <iframe src="{{ url_for('main.preview_case', case_id=case.id) }}"
            style="width: 100%; height: 500px; border: 1px solid #ccc;"
            allowfullscreen>
    </iframe>
  {% endif %}

  {% if not case.is_paid %}
    <div class="alert alert-warning mt-4">
      <strong>To unlock your legal form:</strong><br>
      Pay <strong>$9.99</strong> securely with PayPal or send an e-transfer to:<br>
      <strong>{{ ETRANSFER_EMAIL }}</strong>
    </div>

    <!-- E-Transfer Manual Confirmation -->
    <form id="etransfer-form" method="POST" action="{{ url_for('main.confirm_payment', case_id=case.id) }}">
      <input type="hidden" name="payment_id" value="manual-e-transfer">
      <button type="submit" class="btn btn-secondary">I Paid by E-Transfer</button>
    </form>

    <hr>

    <!-- PayPal Smart Button -->
    <h4>Pay with PayPal</h4>
    <div id="paypal-button-container" class="mt-3"></div>

    <!-- PayPal Submission Hidden Form -->
    <form id="paypal-confirm-form" method="POST" action="{{ url_for('main.paypal_confirm', case_id=case.id) }}">
      <input type="hidden" name="payment_id" id="paypal-payment-id">
    </form>
  {% else %}
    <div class="alert alert-success mt-4">
      <strong>Access Granted:</strong> Your payment has been confirmed. You can now download your legal form.
    </div>

    <a class="btn btn-success" href="{{ url_for('main.download_legal_package', case_id=case.id) }}">
      Download Legal Package
    </a>
  {% endif %}
</div>

<!-- PayPal SDK and Smart Button Logic -->
<script src="https://www.paypal.com/sdk/js?client-id=ARsm9AAW9tT9M4IgU6IzGQbOGB1EdTnl5_jni5Ej1Zkyh2XjdxSftBFiZhAkcStiKiASldayU_GIPlKp&currency=CAD"></script>
<script>
paypal.Buttons({
  createOrder: function(data, actions) {
    return actions.order.create({
      purchase_units: [{ amount: { value: '9.99' } }]
    });
  },
  onApprove: function(data, actions) {
    return actions.order.capture().then(function(details) {
      document.getElementById('paypal-payment-id').value = details.id;
      document.getElementById('paypal-confirm-form').submit();
    });
  },
  onError: function(err) {
    alert("PayPal error: " + err);
  }
}).render('#paypal-button-container');
</script>
{% endblock %}
