@main.route('/upload', methods=['GET', 'POST'])
@login_required
def upload():
    if request.method == 'POST':
        case_title = request.form.get('case_title')
        case_category = request.form.get('case_category')
        files = request.files.getlist('files[]')

        if not case_title or not case_category or not files:
            flash("All fields are required including at least one file.", "danger")
            return redirect(request.url)

        # Create and save the new case
        new_case = Case(
            user_id=current_user.id,
            title=case_title,
            description=f"Uploaded under category: {case_category}",
            legal_issue=case_category,
            matched_keywords="[]",  # placeholder
            confidence_score=0.0    # placeholder
        )
        db.session.add(new_case)
        db.session.commit()

        # Save files to user/case folder
        upload_folder = os.path.join('uploads', str(current_user.id), str(new_case.id))
        os.makedirs(upload_folder, exist_ok=True)

        for file in files:
            if file and allowed_file(file.filename):
                filename = secure_filename(file.filename)
                file_path = os.path.join(upload_folder, filename)
                file.save(file_path)

                # Create Evidence record
                evidence = Evidence(
                    user_id=current_user.id,
                    case_id=new_case.id,
                    filename=filename,
                    file_path=file_path,
                    tag=case_category
                )
                db.session.add(evidence)

        db.session.commit()
        flash("Case created and files uploaded successfully!", "success")
        return redirect(url_for('main.dashboard'))  # Adjust this if you want to land somewhere else

    return render_template('upload.html')
