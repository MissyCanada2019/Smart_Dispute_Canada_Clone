{@app.route("/upload", methods=["GET", "POST"])
@login_required
def upload():
    cases = Case.query.filter_by(user_id=current_user.id).all()
    if request.method == "POST":
        case_id = request.form["case_id"]
        file = request.files.get("document")
        tag = request.form.get("tag")
        notes = request.form.get("notes")

        if file:
            filename = secure_filename(file.filename)
            save_path = os.path.join(app.config["UPLOAD_FOLDER"], filename)
            os.makedirs(app.config["UPLOAD_FOLDER"], exist_ok=True)
            file.save(save_path)

            evidence = Evidence(
                case_id=case_id,
                user_id=current_user.id,
                filename=filename,
                file_path=save_path,
                tag=tag
            )
            db.session.add(evidence)
            db.session.commit()

            # AI Analysis
            text, _ = extract_text_from_file(save_path)
            legal_issue = classify_legal_issue(text)
            merit_score = score_merit(text, legal_issue)
            form = select_form(legal_issue, current_user.province)

            flash(
                f"Evidence uploaded. Case scored {merit_score}% merit. Suggested form: {form}. "
                f"<a href='{url_for('legal_help', case_id=case_id)}' class='alert-link'>View Legal Help</a>",
                "success"
            )
            return redirect(url_for("review_case", case_id=case_id))

    return render_template("upload.html", cases=cases)
